\section{The \sys{} confinement system}
\label{sec:system}

In this section, we describe the \sys{} system.
%
Throughout, we'll refer to our running example, the \emph{password
checker}, which demonstrates many of the key design points of \sys{}.

\subsection{Compartments}

%   Browsing contexts. As shown in Figure 1, a web page
%   consists of content and JavaScript code. A browsing con-
%   text presents a pageâ€™s content to the user, and JavaScript
%   code accesses content within the page through the Docu-
%   ment Object Model (DOM) [34]. Browsing contexts may
%   be nested (e.g., by using iframes). 

% rectangular frames denote
% browser contexts

% Contexts may be labeled with the ori-
%gins to whose sensitive data they have been exposed. A
%context that has not yet observed sensitive data is de-
%noted public , and a page that contains sensitive data
%can raise the label of its own browsing context to its own
%origin.

As mentioned previously, the basic unit of confinement in \sys{}---a
compartment---corresponds to a JavaScript execution context, e.g.\@ a
browser tab, an iframe on a page, or even a Web Worker~\cite{workers}.
%
\sys{} associates each compartment and web site with a security policy,
which specifies the kind of messages and requests which are permitted to
flow to other compartments and web sites.
%
In order to maintain backwards-compatibility, this security policy is
applied on top of the old same-origin policy for existing browser APIs,
merely allowing developers to apply more restrictive policies than
SOP\@.
%
To relax the same-origin policy, \sys{} also introduces variants of
these APIs (most notably labeled XHR, see Section~\Red{ref}) which don't
respect same-origin policy and consequently allow more
use-cases.\footnote{Relaxing the same-origin policy in a way that's
secure and maintains backwards-compatibility is subtle, and we directly
address this issue in Section~\ref{sec:bc}}

%   \footnote{Ordinarily, DOMs
%   are usually only shared between iframes; we also introduce a new type
%   of Web Worker called a DOM Worker which shares a DOM with its parent.
%   These workers run synchronously with the parent (rather than in parallel)
%   and are solely used for confinement: one can think of them as iframes
%   without DOMs of their own.  See Section~\ref{sec:apps-third-party} for
%   one useful use-case for this feature.}

The security policy of a container consists of two components:

\begin{itemize}
    \item A current label (Section~\ref{sec:labels}), which indicates the
        sensitivity of the data in the container,
    \item A set of privileges (Section~\ref{sec:privileges}), which
        dicates what authority the compartment's code has to
        \emph{relax} policy requirements, and
%   \item A clearance (Section~\ref{sec:clearance}), which imposes a
%       limit on the sensitivity of the data in the container.
\end{itemize}

We describe each of these components in turn in the following sections,
and then discuss how these features interoperate smoothly with the old
security policies of the web (Section~\ref{sec:bc}).

\subsection{Labels}
\label{sec:labels}

The \emph{current label} protects all data associated with a compartment or
web site, specifying what origins can read the data.
%
Individual pieces of data can also be labeled (see Section~\ref{sec:labeled-blobs}).
%
The particular labels that are used in \sys{} are \emph{DC labels},
presented in~\cite{stefan:2011:dclabels}.
%
We chose DC labels, much like Hails~\cite{giffin:2012:hails} and
Breeze~\cite{Breeze13}, because they have a simple and clear
semantics, yet are as expressive as the labels used by other practical
confinement systems~\cite{GenLabels}.
%
In this section, we give a brief description of DC labels; an interested
reader should see~\cite{stefan:2011:dclabels} for more details.

A privacy label (henceforth just label) is a boolean formula over
origins.%
%
\footnote{
  Our system also handles \emph{integrity}, but it is omitted from
  the discussion for simplicity.
}
%
When a compartment wishes to send a message to another compartment or
web site, we check if the target label $l'$ logically implies the source
label $l$.
%
Intuitively, this requires that the security of the destination be as strong as original security policy, i.e.\ that the target label \emph{subsumes} the source label.\footnote{If the communication is bidirectional, e.g.\ mutation of a shared DOM, then both the target and source must imply each other.}
%
In the password checker, the labeled password (2) cannot be read by a
publically labeled worker (corresponding to the logical formula
``true''), because ``true'' does not imply ``\https{fb.us}''.
%
However, once the worker raises its label to ``\https{fb.us}'', the
logical implication holds trivially.

%Reworded version: Intuitively, an entity is allowed to receive data that is at most as
%sensitive as its label, i.e., the entity's label always \js|subsumes|
%the label of the data it can receive, preserving the latter's privacy.
%   \Red{maybe something about how this makes it first
%   class: the fact that policies are preserved means that if a library has
%   sub-libraries, they will get the appropriate policy enforced}
%
Why is a label represented as a boolean formula rather than simply
as a set of origins?
%
As it turns out, both conjunctions (``and'')
and disjunctions (``or'') are useful for specifying security policies.
%
Informally, a conjunction describes what origins contributed sensitive data
to the compartment, while a disjunction describes what origins are allowed
to read the data.
%
% EZY: Unfortunately, I can't use the password checker here because
% the labels are too simple
A compartment with the label ``\https{bank.ch} and \https{amazon.com}''
may contain sensitive data from both sites, so it cannot send data to
\https{bank.ch}, as doing so might leak private information from
\https{amazon.com} (and vice versa).
%
Conversely, a compartment labeled ``\https{bank.ch} or \https{amazon.com}''
could send data to either website; however, it could not receive any
messages from either origin---it might have originally been public data
whose sensitivity was raised so that no other site could read it.

How is the current label initially determined?
%
\sys{} extends the API of iframes and workers so that when they are
created, a particular current label can be assigned to it (which
must subsume the parent's label).  Otherwise, new containers implicitly
inherit the label of its parent.\footnote{Perceptive readers may now be wondering how
the password checker arranged to create a publically labeled worker
when its label was \https{fb.us}.  In fact, doing so is not possible
to do so without privileges (Section~\ref{sec:privileges}).}
%
For web pages proper, we look for a {\tt Document-label} header to
specify the initial label, defaulting to the origin of the web site when
this header is not present.
%
After creation, a compartment can freely \emph{raise} its label, i.e.\
change its label to any label which subsumes it, but not vice versa.
%
This leads to a common interpretation of labels as ``taint;'' as
a compartment receives data from more sources, it accumulates more
conjuncts on account of raising its label to read the received data.

\subsubsection{Labeled blobs}
\label{sec:labeled-blobs}

A \emph{labeled blob} is a piece of data with a label
associated with it.
%
The contents of a labeled blob are opaque: in order to
inspect these contents, we must check that the label of the environment
subsumes the label of the blob.
%
In the password checker, the password passed to the untrusted worker
is explicitly labeled with ``\https{fb.us}'', to ensure that the worker
taints itself once the password is read.\footnote{This is important
when privileges are in use; see the next section.}

Labeled blobs can be explicitly created by the programmer and then
passed around by container-to-container message passing.
%
Labeled blobs can also be created from requests to websites using
\emph{labeled XHR}: instead of immediately raising the label upon
receiving the result, a labeled blob is returned instead.
%
This allows a developer to defer reading the result of a request. This
is useful if the compartment is simply passing the labeled blob to
another compartment, or querying multiple websites of different origins
before reading the results all at once (Section~\ref{sec:apps-mashup}).

% maybe footnote about integrity

\subsection{Privileges}
\label{sec:privileges}

% Description of privileges
A \emph{privilege} is an object, representing an origin, which confers
the authority to relax policy requirements with respect to this origin.
%
While privileges can be used in a variety of ways, their basic mechanism
is quite simple:  whenever a compartment with a privilege $p$ performs a
label check, instead of checking that $l'$ implies $l$, we check that
$l'$ and $p$ implies $l$.

There are two primary use-cases for privileges:

\begin{itemize}
    \item A privilege can be used to \emph{declassify} private
        information without raising the current label.  For example, we
        could downgrade ``\https{amazon.com}'' labeled data to
        ``public''; we could even downgrade it to ``\https{amazon.com}
        or \https{bank.ch}'' (recall that this data can be read only
        either origin, but no others).

    \item A privilege can be used to lower the current label of
        a compartment (or a compartment that is being created).
        This is how privileges are used
        in the password checker: the untrusted worker was created
        with a current label of ``public'' by exercising the
        \https{fb.us} privilege in the main web site.  Conceptually, we
        are declassifying \emph{all} of the data associated with the
        compartment.
\end{itemize}

In \sys{}, privileges are \emph{implicitly} exercised: if a compartment
has a privilege, it will always attempt to use it.  To force a label
check without the privilege, a privileged compartment can wrap the
data in question as a labeled blob.  In the password checker, the main
page must do precisely this, as it has the \https{fb.us} privilege and
thus sending the password directly would be equivalent to publishing it.
\Red{I am a bit afraid this is hard to understand.}

% Initial privileges and privilege creation
By default, a browsing context has the privilege corresponding to the
page origin; this context can drop the privilege if it is not
needed or spawn other containers sans privilege to run untrusted code.
%
While privileges for existing origins cannot be created, a privilege can
be created for a fresh origin, i.e.\ an origin which does not correspond
any actual web site, but which is guaranteed to be unique.
%
A fresh origin is often used to run code under full isolation, since any
compartment labeled with the fresh origin cannot communicate with any
other compartment without exercising the corresponding privilege.
%
Importantly, any code can allocate a origin-privilege pair: this
makes isolation an egalitarian security mechanism: an untrusted library
can use this mechanism to isolate a sub-library that it itself
may not trust~\cite{Zeldovich:2006}.

\subsection{Backwards compatibility}
\label{sec:bc}

\Red{see TODO for notes}

%   \subsection{Clearance}
%   \label{sec:clearance}

%   \emph{Clearance} is a label which imposes a limit on the kind of data a compartment can have,
%   i.e., it is an upper-bound on compartment label, and thus the kind of
%   data a piece of code executing in the compartment can access.
%   %
%   In an ideal confinement system, code can read arbitrary data at the
%   cost of raising the context label (and thus giving up write
%   capabilities).
%   %
%   Unfortunately, practical systems typically have covert channels which
%   may be exploited to leak sensitive data.
%   %
%   Hence, as in HiStar~\cite{Zeldovich:2006}, Hails~\cite{giffin:2012:hails}, and
%   Breeze~\cite{Breeze13} we associate a \emph{clearance} with every
%   compartment: the compartment is not allowed to raise its label higher
%   than the clearance.

%   \Red{Clearance choice by user? We need to know what the default
%       clearance is.  The attack model is kind of funny: we want to argue
%       that covert channels are obvious (e.g. crashing your browser) or low
%       bit-rate; i.e. set in such a way that opting in to run the untrusted
%   code on the sensitive data is materially less harmful than if the
%   untrusted code ran automatically}

%   In \sys{}, the clearance assigned to browsing contexts is primarily a
%   choice made by the user.
%   %
%   ``Do I want to give this mash-up website (confined) access to my
%   bank statement?''  In absence of covert channels, the user's choice
%   makes no difference
%   \Red{Similarity to content scripts}

%   For completeness, we summarize  \sys{}'s API for compartments
%   in Figure~\ref{systemAPI}. In the next subsection, 
%   we explain the purpose of the different primitives through examples. 
%   We remark that \sys{}'s API is designed to be minimalistic, and as such, it only
%   consists on the primitives shown in Figures~\ref{fig:APIspec} and
%   \ref{systemAPI}.

%   In the rest of this section, we expand on the \sys{} design by
%   introducing mechanisms that meet the requirements of the four
%   example applications described in Section~\ref{sec:goals}.
%% through
%% three concrete examples: 
%% a password-strength checker (Section~\ref{sec:system:worker}),
%% a password manager (Section~\ref{sec:system:iframe}), 
%% a third-party mashup (Section~\ref{sec:system:mashup}), and
%% a library that converts phone numbers to links
%% (Section~\ref{sec:system:script}--Section~\ref{sec:system:extension}).
%
%For completeness, we summarize the different system components,
%security mechanisms, and DOM API (using WebIDL-like syntax), in
%Table~\toref{table:components}.


% Implementation notes:
% postMessage: receiver subsumes sender
% DOM: receiver =_p sender plus DOM access label =_p sender

% Local Variables:
% TeX-master: "main.ltx"
% TeX-command-default: "Make"
% End:

